@name TurretV0.3
@inputs Target1:vector Weapon:entity
@outputs Bearing:angle TurretBearing:angle BearingDiff Dis
@persist Base:entity Middle:entity Turret:entity X Pitch Speed
@trigger 
@model models/stat_turrets/st_turretbase.mdl

interval(100)

if(first())
{
    Base=entity()
    Middle=holoCreate(1,Base:boxCenterW()+vec(0,0,(Base:boxSize():z()/2)+0),vec(1,1,1))
    holoModel(1,"models/stat_turrets/st_turretswivel.mdl")
    holoParent(1,Base)
    Speed = 7 #I think this is in angles per execution
    Turret=holoCreate(2,Base:boxCenterW()+vec(0,0,(Base:boxSize():z()/2)+10),vec(1,1,1))
    holoColor(2,vec(255,0,0))
    findByModel("models/stat_turrets/st_turretmissile.mdl")
    findIncludePlayerProps(owner())
    holoPos(2,findResult(1):pos())
    holoAng(2,findResult(1):angles())
    findResult(1):parentTo(Turret)
    holoPos(2,Base:boxCenterW()+vec(0,0,(Base:boxSize():z()/2)+20))
    holoAng(2,Middle:angles())
    holoParent(2,Middle)
    holoCreate(5)
    holoPos(5,Weapon:pos())
    holoAng(5,Weapon:angles())
    Weapon:parentTo(holoEntity(5))
    function parentWeapon(){
        holoPos(5,holoEntity(2):pos())
        holoAng(5,holoEntity(2):angles())
        holoParent(5,2)
    }
    timer(50,1,"parent","parentWeapon()")
}

function angle smoothness(CurrentAngle:angle,WantedAngle:angle) {
    local WantedQuat = quat(WantedAngle)
    local CurrentQuat = quat(CurrentAngle)
        
    local LengthQ = abs(rotationAngle(WantedQuat/CurrentQuat))
    local Tick = clamp(Speed/LengthQ,0,1)
    local Quat = slerp(CurrentQuat,WantedQuat,Tick)
        
    return Quat:toAngle()
}
Target=entity(645):pos()
AngleToTarget = (Target-Middle:pos()):toAngle()
TurretAngle = Middle:angles()
holoAng(1,ang(0,smoothness(TurretAngle,AngleToTarget):yaw(),0))
holoAng(2,smoothness(TurretAngle,AngleToTarget))
